<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuDS Enviro - Catchpit Configurator</title> <!-- Standardized Title -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css"> <!-- Link to shared CSS -->
    <!-- INTERNAL <STYLE> BLOCK REMOVED -->
</head>
<body>
   <!-- NEW NAVBAR - Standardized -->
<nav class="navbar">
    <a href="index.html" class="nav-logo">
        <img src="assets/images/logo_horizontal.png" alt="SuDS Enviro Logo"> <!-- Standardized Logo Path -->
    </a>
    <button class="menu-toggle" id="mobileMenuToggle" aria-label="Toggle Menu" aria-expanded="false">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
    </button>
    <ul class="nav-links" id="navLinks">
        <li><a href="index.html">Tools Hub</a></li>
        <li><a href="planner.html">Drainage Planner</a></li>
        <li><a href="all_configs.html">Saved Configurations</a></li>
        <li><a href="catchpit.html" class="active">Catchpit Config</a></li> <!-- Active Link -->
        <li><a href="orifice.html">Orifice Config</a></li>
        <li><a href="universal_chamber.html">Chamber Config</a></li>
        <li><a href="separator.html">Separator Config</a></li>
        <!-- Add link to ai_analyzer.html here later if needed -->
    </ul>
</nav>

    <form id="sudsCatchpitForm" class="suds-configurator-form">
        <!-- Original form content from your provided catchpit.html STARTING from <div class="suds-form-section"> -->
        <div class="suds-form-section">
            <h2>Catchpit Configuration</h2>

            <h3>Catchpit Properties</h3>
            <div class="suds-form-group">
                <label class="suds-label" for="cp_type">Catchpit Type:</label>
                <select class="suds-select" id="cp_type" name="cp_type" required>
                    <option value="">-- Select Type --</option>
                    <option value="Standard">Standard</option>
                    <option value="Bucket">Bucket</option>
                    <option value="Dual Filter">Dual Filter</option>
                </select>
            </div>
            <div class="suds-form-group">
                <label class="suds-label">Adoptable Status:</label>
                <div class="suds-radio-group" id="adoptable_status_group">
                     <div>
                        <input type="radio" id="adoptable_yes" name="adoptable_status" value="adoptable" required>
                        <label for="adoptable_yes">Adoptable</label>
                     </div>
                     <div>
                        <input type="radio" id="adoptable_no" name="adoptable_status" value="non_adoptable" required>
                        <label for="adoptable_no">Non-Adoptable</label>
                     </div>
                </div>
             </div>
            <div class="suds-form-group">
                <label class="suds-label" for="cp_depth">Chamber depth (mm):</label>
                <select class="suds-select" id="cp_depth" name="cp_depth" required disabled>
                    <option value="">-- Select Adoptable Status First --</option>

                </select>
            </div>
            <div class="suds-form-group">
                 <label class="suds-label" for="cp_pipework_diameter">Pipework Diameter (mm):</label>
                 <select class="suds-select" id="cp_pipework_diameter" name="cp_pipework_diameter" required>
                     <option value="">-- Select Size --</option>
                     <option value="110mm">110mm</option>
                     <option value="160mm">160mm</option>
                     <option value="225mm">225mm</option>
                 </select>
             </div>

            <h3>Functionality</h3>
             <div class="suds-form-group">
                <label class="suds-label" for="cp_target_pollutant">Target Pollutant:</label>
                <select class="suds-select" id="cp_target_pollutant" name="cp_target_pollutant" required>
                    <option value="">-- Select Target --</option>
                    <option value="Silt">Silt</option>
                    <option value="Leaves">Leaves</option>
                    <option value="Oils">Oils</option>
                    <option value="All">All (General Debris)</option>
                </select>
            </div>
            <div class="suds-form-group">
                <label class="suds-label">Removable Bucket?</label>
                 <div class="suds-radio-group" id="removable_bucket_group">
                     <div>
                        <input type="radio" id="bucket_yes" name="removable_bucket" value="yes">
                        <label for="bucket_yes">Yes</label>
                     </div>
                     <div>
                        <input type="radio" id="bucket_no" name="removable_bucket" value="no" checked>
                        <label for="bucket_no">No</label>
                     </div>
                </div>
            </div>
        </div>

        <div id="suds_product_code_display_container">
            <span id="suds_product_code_display_label">Generated Product Code:</span>
            <span id="suds_product_code_display">Please make selections...</span>
        </div>

        <details id="shopping_list_details">
            <summary id="shopping_list_summary">Estimated Quote / Shopping List</summary>
            <div id="shopping_list_container">
                <ul id="shopping_list_items">
                    <li>Select options to see quote...</li>
                </ul>
                <div class="quote-calculation-area">
                    <div class="suds-form-group markup-group">
                        <label class="suds-label" for="profit_markup_percent">Profit Markup (%):</label>
                        <input type="number" id="profit_markup_percent" name="profit_markup_percent" class="suds-input" min="0" step="0.1" value="0" placeholder="e.g., 15.5">
                    </div>
                    <div id="shopping_list_total">
                        <span id="cost_price_label">Cost Price:</span>
                        <span id="cost_price_value">£0.00</span>
                    </div>
                    <div id="shopping_list_sell_price">
                        <span id="sell_price_label">Sell Price (inc. Markup):</span>
                        <span id="sell_price_value">£0.00</span>
                    </div>
                </div>
            </div>
        </details>

        <button type="submit" class="suds-submit-btn">Submit Catchpit Configuration</button>
        <div id="suds_submit_status"></div>
        <!-- Original form content from your provided catchpit.html ENDS here -->
    </form>

    <!-- Existing script tag for catchpit.js -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Pricing Rules for Catchpit
        const pricingRules = {
            base: 40.00,
            type_adder: { 'Standard': 0, 'Bucket': 30.00, 'Dual Filter': 75.00 },
            adoptable_status: {'adoptable': 50.00, 'non_adoptable': 0},
            depth_base: 50.00,
            depth_per_150mm_step: 10.00,
            pipe_diameter_adder: { '110mm': 0, '160mm': 5.00, '225mm': 15.00 },
            pollutant_adder: { 'Silt': 0, 'Leaves': 10.00, 'Oils': 50.00, 'All': 70.00 },
            removable_bucket_adder: 20.00 // Only if removable_bucket is 'yes'
        };

        // DOM References
        const form = document.getElementById('sudsCatchpitForm');
        const submitStatus = document.getElementById('suds_submit_status');
        const webhookUrl = 'https://mkiminstest.app.n8n.cloud/webhook-test/862c9207-f6dd-4ee7-ae40-4658d15de3d0';
        const productCodeDisplay = document.getElementById('suds_product_code_display');
        const shoppingListItemsUl = document.getElementById('shopping_list_items');
        const costPriceValueSpan = document.getElementById('cost_price_value');
        const sellPriceValueSpan = document.getElementById('sell_price_value');
        const profitMarkupInput = document.getElementById('profit_markup_percent');

        const catchpitTypeSelect = document.getElementById('cp_type');
        const chamberDepthSelect = document.getElementById('cp_depth');
        const adoptableStatusGroup = document.getElementById('adoptable_status_group');
        const pipeworkDiameterSelect = document.getElementById('cp_pipework_diameter');
        const targetPollutantSelect = document.getElementById('cp_target_pollutant');
        const removableBucketGroup = document.getElementById('removable_bucket_group');

        // ***** MODIFICATION: localStorage key for saved configurations from all forms *****
        const savedConfigStorageKey = 'sudsSavedConfigs';
        // ***** END MODIFICATION *****


        function formatCurrency(value) { return `£${value.toFixed(2)}`; }

        function populateDepthOptions() {
            const selectedAdoptable = document.querySelector('input[name="adoptable_status"]:checked'); const adoptableValue = selectedAdoptable?.value; const currentDepthValue = chamberDepthSelect.value; chamberDepthSelect.innerHTML = '';
            if (!adoptableValue) { chamberDepthSelect.disabled = true; const o=document.createElement('option');o.value="";o.textContent="-- Select Adoptable Status First --";chamberDepthSelect.appendChild(o);updateProductCodeDisplay();updateQuoteDisplay();return; }
            chamberDepthSelect.disabled = false; const dO=document.createElement('option');dO.value="";dO.textContent="-- Select Depth --";chamberDepthSelect.appendChild(dO);
            const minD=600; const maxD=(adoptableValue==='adoptable')?3000:6000; const inc=150;
            for (let d=minD; d<=maxD; d+=inc) { const o=document.createElement('option');o.value=d;o.textContent=`${d}mm`;chamberDepthSelect.appendChild(o); }
            if (currentDepthValue&&chamberDepthSelect.querySelector(`option[value="${currentDepthValue}"]`)){chamberDepthSelect.value=currentDepthValue;} else {chamberDepthSelect.value="";} updateProductCodeDisplay();updateQuoteDisplay();
        }

        function calculateQuote() {
            let totalCost = 0; const items = []; const formData = new FormData(form);
            totalCost += pricingRules.base; items.push({ description: "Catchpit Base Unit", cost: pricingRules.base });
            const cpType = formData.get('cp_type'); if (cpType && pricingRules.type_adder[cpType]) { const c = pricingRules.type_adder[cpType]; if(c > 0) items.push({description: `Type: ${cpType}`, cost: c}); totalCost += c; }
            const adoptableStatus = formData.get('adoptable_status'); if (adoptableStatus && pricingRules.adoptable_status[adoptableStatus]) { const c=pricingRules.adoptable_status[adoptableStatus]; if(c>0)items.push({description:`Status: ${adoptableStatus.charAt(0).toUpperCase() + adoptableStatus.slice(1)}`, cost: c }); totalCost += c; }
            const depth = parseFloat(formData.get('cp_depth')); if (depth && depth >= 600) { let depthCost = pricingRules.depth_base; const steps = (depth - 600) / 150; depthCost += steps * pricingRules.depth_per_150mm_step; items.push({description:`Depth: ${depth}mm`,cost:depthCost}); totalCost+=depthCost; }
            const pipeDiameter = formData.get('cp_pipework_diameter'); if (pipeDiameter && pricingRules.pipe_diameter_adder[pipeDiameter]) { const c = pricingRules.pipe_diameter_adder[pipeDiameter]; if(c > 0) items.push({description: `Pipe Connections: ${pipeDiameter}`, cost: c * 2}); totalCost += (c*2); }
            const pollutant = formData.get('cp_target_pollutant'); if(pollutant && pricingRules.pollutant_adder[pollutant]) { const c = pricingRules.pollutant_adder[pollutant]; if(c > 0) items.push({description: `Target: ${pollutant}`, cost: c}); totalCost += c; }
            const removableBucket = formData.get('removable_bucket'); if(removableBucket === 'yes') { items.push({description: "Removable Bucket", cost: pricingRules.removable_bucket_adder}); totalCost += pricingRules.removable_bucket_adder; }

            return { total: totalCost, items: items };
        }

        function updateQuoteDisplay() {
             const quote=calculateQuote(); const costPrice=quote.total; const markupPercent=parseFloat(profitMarkupInput.value)||0; const sellPrice=costPrice*(1+markupPercent/100); shoppingListItemsUl.innerHTML=''; if(quote.items.length>0){quote.items.forEach(item=>{const li=document.createElement('li');li.innerHTML=`<span class="item-description">${item.description}</span><span class="item-cost">${formatCurrency(item.cost)}</span>`;shoppingListItemsUl.appendChild(li);});}else{shoppingListItemsUl.innerHTML='<li>Select options to see quote...</li>';} costPriceValueSpan.textContent=formatCurrency(costPrice); sellPriceValueSpan.textContent=formatCurrency(sellPrice);
        }

        function getShortCode(value, mapping) {
             return mapping[value] || value.substring(0,3).toUpperCase();
        }

        function updateProductCodeDisplay() {
            const name = "SECP";
            const typeCodeMapping = { "Standard": "STD", "Bucket": "BKT", "Dual Filter": "DFL"};
            const pollutantCodeMapping = { "Silt": "SIL", "Leaves": "LEA", "Oils": "OIL", "All": "ALL"};

            const type = catchpitTypeSelect.value ? getShortCode(catchpitTypeSelect.value, typeCodeMapping) : 'TYPE';
            const pollutant = targetPollutantSelect.value ? getShortCode(targetPollutantSelect.value, pollutantCodeMapping) : 'POLL';
            const pipeDia = pipeworkDiameterSelect.value ? pipeworkDiameterSelect.value.replace('mm','') : 'DIA';
            const depth = chamberDepthSelect.value || 'DEPTH';
            const bucketCode = document.querySelector('input[name="removable_bucket"]:checked')?.value === 'yes' ? 'RB' : 'NR';
            const adoptableCode = document.querySelector('input[name="adoptable_status"]:checked')?.value === 'adoptable' ? 'AD' : 'NA';
            const adoptableSelected = form.querySelector('input[name="adoptable_status"]:checked');

            if(type === 'TYPE' || pollutant === 'POLL' || pipeDia === 'DIA' || depth === 'DEPTH' || !adoptableSelected || !chamberDepthSelect.value) {
                 productCodeDisplay.textContent='Please complete selections...'; return;
            }
            productCodeDisplay.textContent = `${name}-${type}-${pollutant}-${pipeDia}-${depth}-${bucketCode}-${adoptableCode}`;
        }

        function updateQuoteAndCode() { updateProductCodeDisplay(); updateQuoteDisplay(); }

        const elementsTriggeringUpdates = [
            catchpitTypeSelect, chamberDepthSelect, adoptableStatusGroup,
            pipeworkDiameterSelect, targetPollutantSelect, removableBucketGroup,
            profitMarkupInput
        ];
        elementsTriggeringUpdates.forEach(el => {
            el.addEventListener('change', updateQuoteAndCode);
            if (el.type === 'number' || el.type === 'text') {
                 el.addEventListener('keyup', updateQuoteAndCode);
                 el.addEventListener('input', updateQuoteAndCode);
            }
        });
        adoptableStatusGroup.addEventListener('change', () => { populateDepthOptions(); });

        populateDepthOptions(); updateProductCodeDisplay(); updateQuoteDisplay();

        form.addEventListener('submit', function(event) {
             event.preventDefault(); submitStatus.textContent = 'Submitting...'; submitStatus.className = ''; form.querySelectorAll('.suds-input, .suds-select').forEach(el => el.style.borderColor = ''); adoptableStatusGroup.style.outline = 'none'; let isValid = true; const adoptableSelected = form.querySelector('input[name="adoptable_status"]:checked'); if (!adoptableSelected) { isValid = false; adoptableStatusGroup.style.outline = '2px solid var(--suds-red)'; } else { adoptableStatusGroup.style.outline = 'none'; }

             const requiredStaticFields = form.querySelectorAll('#cp_type[required], #cp_depth[required], #cp_pipework_diameter[required], #cp_target_pollutant[required]');
             requiredStaticFields.forEach(input => { if ((input.tagName === 'SELECT' && input.value === "") || (input.tagName !== 'SELECT' && !input.value.trim())) { isValid = false; input.style.borderColor = 'var(--suds-red)'; } else { input.style.borderColor = ''; } });
             const bucketSelected = form.querySelector('input[name="removable_bucket"]:checked');
             if (!bucketSelected) isValid = false;

             if (!isValid) { submitStatus.textContent = 'Please fill in all required fields.'; submitStatus.className = 'suds_status_error'; const firstInvalidField = form.querySelector('[style*="border-color: var(--suds-red)"], [style*="outline"]'); if (firstInvalidField) { firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' }); if (firstInvalidField.tagName !== 'SELECT' && firstInvalidField.type !== 'radio') { firstInvalidField.focus();} } return; }

             const payload = buildJsonPayload();

             // Note: Webhook submission can still happen if desired.
             // For this internal tool, saving to localStorage is the primary goal for planner integration.
             // fetch(webhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).then(...)

             // ***** MODIFICATION: Save to localStorage *****
             try {
                 const configToSave = { ...payload };
                 configToSave.savedId = `suds-cp-${Date.now()}`;
                 configToSave.savedTimestamp = new Date().toISOString();

                 const existingConfigsRaw = localStorage.getItem(savedConfigStorageKey);
                 let savedConfigs = [];
                 if (existingConfigsRaw) {
                     try {
                         savedConfigs = JSON.parse(existingConfigsRaw);
                         if (!Array.isArray(savedConfigs)) savedConfigs = [];
                     } catch (e) {
                         console.error("Error parsing existing localStorage data for sudsSavedConfigs:", e);
                         savedConfigs = [];
                     }
                 }

                 savedConfigs.push(configToSave);
                 localStorage.setItem(savedConfigStorageKey, JSON.stringify(savedConfigs));
                 console.log("Catchpit configuration saved to localStorage.");
                 submitStatus.textContent = 'Catchpit configuration saved successfully!';
                 submitStatus.className = 'suds_status_success';
             } catch (storageError) {
                 console.error("Error saving Catchpit configuration to localStorage:", storageError);
                 submitStatus.textContent = 'Saving to local storage failed: ' + (storageError.message || 'Unknown error.');
                 submitStatus.className = 'suds_status_error';
             }
            // ***** END MODIFICATION *****

            form.reset();
            populateDepthOptions();
            updateProductCodeDisplay();
            updateQuoteDisplay();
        });

        function buildJsonPayload() {
            const formData = new FormData(form);
            const quote = calculateQuote();
            const costPrice = quote.total;
            const markupPercent = parseFloat(profitMarkupInput.value) || 0;
            const sellPrice = costPrice * (1 + markupPercent / 100);

            // ***** MODIFICATION: Add derived_product_name for planner compatibility *****
            let derivedProductName = "Catchpit";
            const cpTypeValue = formData.get('cp_type');
            if (cpTypeValue) {
                derivedProductName = `Catchpit (${cpTypeValue})`;
            }
            // ***** END MODIFICATION *****

            const payload = {
                product_type: "catchpit",
                // ***** MODIFICATION: Add fields for planner *****
                derived_product_name: derivedProductName,
                generated_product_code: productCodeDisplay.textContent.startsWith('Please') ? null : productCodeDisplay.textContent,
                // ***** END MODIFICATION *****
                adoptable_status: formData.get('adoptable_status'),
                catchpit_details: {
                    catchpit_type: cpTypeValue,
                    depth_mm: parseFloat(formData.get('cp_depth'))||null,
                    pipework_diameter: formData.get('cp_pipework_diameter'),
                    target_pollutant: formData.get('cp_target_pollutant'),
                    removable_bucket: formData.get('removable_bucket') === 'yes'
                },
                quote_details: {
                    items: quote.items,
                    cost_price: costPrice,
                    profit_markup_percent: markupPercent,
                    estimated_sell_price: sellPrice
                }
            };
            return payload;
        }

    });
    </script>
    <script src="js/main.js" defer></script> <!-- Link to common navbar JS -->
</body>
</html>
